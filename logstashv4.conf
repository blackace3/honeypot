# ============================================================
# INPUT SECTION
# ============================================================
input {
  # Cowrie
  file {
    path            => "/srv/honeypots/cowrie/log/*.json"
    start_position  => "beginning"
    type            => "cowrie"
    codec           => json
  }

  # Dionaea
  file {
    path            => "/srv/honeypots/dionaea/log/*.json"
    start_position  => "beginning"
    type            => "dionaea"
    codec           => json
  }

  # Honeytrap
  file {
    path            => "/srv/honeypots/honeytrap/log/*.log"
    start_position  => "beginning"
    type            => "honeytrap"
    codec           => json
  }

  # Conpot
  file {
    path            => "/srv/honeypots/conpot/log/*.json"
    start_position  => "beginning"
    type            => "conpot"
    codec           => json
  }
}

# ============================================================
# FILTER SECTION
# ============================================================
filter {

  # ------------------------------------------------------------
  # COWRIE
  # ------------------------------------------------------------
  if [type] == "cowrie" {

    if [timestamp] {
      date {
        match  => ["timestamp", "ISO8601"]
        target => "@timestamp"
      }
    }

    if [eventid] == "cowrie.session.connect" {
      mutate {
        add_field => {
          "event.category"     => "network"
          "event.type"         => "connection"
          "network.protocol"   => "%{protocol}"
          "source.ip"          => "%{src_ip}"
          "source.port"        => "%{src_port}"
          "destination.ip"     => "%{dst_ip}"
          "destination.port"   => "%{dst_port}"
        }
        convert => {
          "src_port" => "integer"
          "dst_port" => "integer"
        }
      }
    }

    if [eventid] == "cowrie.client.version" {
      mutate {
        add_field => {
          "event.category"     => "network"
          "event.type"         => "info"
          "cowrie.ssh_version" => "%{version}"
          "source.ip"          => "%{src_ip}"
        }
      }
    }

    if [eventid] == "cowrie.client.kex" {
      mutate {
        add_field => {
          "event.category"     => "network"
          "event.type"         => "info"
          "cowrie.ssh.hassh"   => "%{hassh}"
        }
      }
    }

    if [eventid] == "cowrie.login.failed" {
      mutate {
        add_field => {
          "event.category"     => "authentication"
          "event.type"         => "failed"
          "user.name"          => "%{username}"
          "cowrie.password"    => "%{password}"
          "source.ip"          => "%{src_ip}"
        }
      }
    }

    if [eventid] == "cowrie.session.closed" {
      mutate {
        add_field => {
          "event.category"     => "network"
          "event.type"         => "disconnect"
          "cowrie.duration"    => "%{duration}"
          "source.ip"          => "%{src_ip}"
        }
        convert => { "duration" => "float" }
      }
    }

    mutate { remove_field => ["message", "timestamp"] }
  }

  # ------------------------------------------------------------
  # DIONAEA
  # ------------------------------------------------------------
  if [type] == "dionaea" {

    mutate {
      add_field => {
        "timestamp"       => "%{[dionaea][timestamp]}"
        "src_ip"          => "%{[dionaea][src_ip]}"
        "src_port"        => "%{[dionaea][src_port]}"
        "dst_ip"          => "%{[dionaea][dst_ip]}"
        "dst_port"        => "%{[dionaea][dst_port]}"
        "protocol"        => "%{[dionaea][connection][protocol]}"
        "transport"       => "%{[dionaea][connection][transport]}"
        "connection_type" => "%{[dionaea][connection][type]}"
      }
    }

    mutate {
      add_field => {
        "[source][ip]"         => "%{src_ip}"
        "[source][port]"       => "%{src_port}"
        "[destination][ip]"    => "%{dst_ip}"
        "[destination][port]"  => "%{dst_port}"
        "[network][protocol]"  => "%{protocol}"
        "[network][transport]" => "%{transport}"
      }
    }

    mutate {
      convert => {
        "[source][port]"      => "integer"
        "[destination][port]" => "integer"
      }
    }

    if ([dionaea][credentials]) {
      ruby {
        code => '
          creds = event.get("[dionaea][credentials]")
          if creds.is_a?(Array) && creds.first
            event.set("[auth][username]", creds.first["username"])
            event.set("[auth][password]", creds.first["password"])
            event.set("has_credentials", true)
          end
        '
      }
      mutate {
        add_field => {
          "event.type"     => "bruteforce"
          "event.category" => "authentication"
        }
      }
    } else {
      mutate {
        add_field => {
          "event.type"     => "connection"
          "event.category" => "network"
        }
      }
    }

    if [protocol] == "mssqld" { mutate { add_field => { "service" => "mssql" } } }
    if [protocol] == "smbd"   { mutate { add_field => { "service" => "smb"   } } }
    if [protocol] == "httpd"  { mutate { add_field => { "service" => "http"  } } }
    if [protocol] == "mysqld" { mutate { add_field => { "service" => "mysql" } } }

    date {
      match  => ["timestamp", "ISO8601"]
      target => "@timestamp"
    }

    mutate { remove_field => ["message"] }
  }

  # ------------------------------------------------------------
  # HONEYTRAP
  # ------------------------------------------------------------
  if [type] == "honeytrap" {

    mutate {
      rename => {
        "date"             => "timestamp"
        "source-ip"        => "source_ip"
        "source-port"      => "source_port"
        "destination-ip"   => "destination_ip"
        "destination-port" => "destination_port"
        "message"          => "error_message"
      }
    }

    mutate {
      convert => {
        "source_port"      => "integer"
        "destination_port" => "integer"
      }
    }

    mutate { add_tag => ["honeytrap"] }

    if [type] == "fatal" {
      mutate { add_tag => ["fatal_error", "panic"] }
    }

    multiline {
      pattern => "^\s+|^goroutine"
      what    => "previous"
    }
  }

  # ------------------------------------------------------------
  # CONPOT
  # ------------------------------------------------------------
  if [type] == "conpot" {

    mutate {
      rename => {
        "id"         => "session_id"
        "data_type"  => "protocol"
        "request"    => "request_raw"
        "response"   => "response_raw"
      }
    }

    date {
      match  => ["timestamp", "ISO8601"]
      target => "@timestamp"
    }

    if [request_raw] and [request_raw] != "(None, [], None)" {

      grok {
        match          => { "request_raw" => "^.'(?<http_path>[^']+)'" }
        tag_on_failure => []
      }

      grok {
        match          => { "request_raw" => "\[(?<header_block>.*)\]" }
        tag_on_failure => []
      }

      mutate {
        gsub => [
          "header_block", "\(", "[",
          "header_block", "\)", "]",
          "header_block", "'", "\""
        ]
      }

      json {
        source          => "header_block"
        target          => "http_headers"
        tag_on_failure  => []
      }
    }

    if [response_raw] {
      mutate {
        gsub => [
          "response_raw", "^b'", "",
          "response_raw", "\\\\r\\\\n'$", ""
        ]
      }
    }

    mutate {
      lowercase => ["protocol"]
      add_field => { "event.module" => "conpot" }
    }
  }
}

# ============================================================
# OUTPUT SECTION (dibedakan per honeypot)
# ============================================================
output {

  # ---------------- COWRIE ----------------
  if [type] == "cowrie" {
    elasticsearch {
      hosts                       => ["elasticsearch:9200"]
      index                       => "honeypot-cowrie-%{+YYYY.MM.dd}"
      user                        => ""
      password                    => ""
      ssl                         => true
      ssl_certificate_verification => false
    }
    file {
      path  => "/var/log/logstash/honeypot-cowrie-%{+YYYY-MM-dd}.log"
      codec => json_lines
    }
  }

  # ---------------- DIONAEA ----------------
  if [type] == "dionaea" {
    elasticsearch {
      hosts                       => ["elasticsearch:9200"]
      index                       => "honeypot-dionaea-%{+YYYY.MM.dd}"
      user                        => ""
      password                    => ""
      ssl                         => true
      ssl_certificate_verification => false
    }
    file {
      path  => "/var/log/logstash/honeypot-dionaea-%{+YYYY-MM-dd}.log"
      codec => json_lines
    }
  }

  # ---------------- HONEYTRAP ----------------
  if [type] == "honeytrap" {
    elasticsearch {
      hosts                       => ["elasticsearch:9200"]
      index                       => "honeypot-honeytrap-%{+YYYY.MM.dd}"
      user                        => ""
      password                    => ""
      ssl                         => true
      ssl_certificate_verification => false
    }
    file {
      path  => "/var/log/logstash/honeypot-honeytrap-%{+YYYY-MM-dd}.log"
      codec => json_lines
    }
  }

  # ---------------- CONPOT ----------------
  if [type] == "conpot" {
    elasticsearch {
      hosts                       => ["elasticsearch:9200"]
      index                       => "honeypot-conpot-%{+YYYY.MM.dd}"
      user                        => ""
      password                    => ""
      ssl                         => true
      ssl_certificate_verification => false
    }
    file {
      path  => "/var/log/logstash/honeypot-conpot-%{+YYYY-MM-dd}.log"
      codec => json_lines
    }
  }
}
